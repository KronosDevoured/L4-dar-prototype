<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/><title>L4 — Blender-Style + XYZ Gizmo + DAR Cross-Damp</title><style>html,body{margin:0;padding:0;height:100%;background:#fff;color:#0e0f12;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overscroll-behavior:none}*:where(*){box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}#gl,#hud{position:fixed;inset:0;display:block}#gl{z-index:0}#hud{z-index:1;touch-action:none}:root{--bg-grad:linear-gradient(180deg,#f6f7fb 0%,#eef1f6 45%,#e9edf3 100%)}.theme-dark{--bg-grad:linear-gradient(180deg,#111318 0%,#0f1217 40%,#0d0f14 100%)}body{background:var(--bg-grad)}#menuBtn,#themeToggle{position:fixed;top:.6rem;z-index:3;width:44px;height:44px;border-radius:12px;border:1px solid #3a3d45;background:#181a20;box-shadow:0 2px 10px rgba(0,0,0,.25)}#menuBtn{right:.6rem;display:grid;place-items:center}#menuBtn .bar{display:block;width:20px;height:2px;background:#e8e8ea;margin:3px 0}#menuBtn.active{background:#06f;border-color:#4c8dff}#themeToggle{right:3.9rem;color:#e8e8ea;font-weight:700;cursor:pointer}#menuOverlay{position:fixed;inset:0;z-index:4;display:none;background:rgba(10,12,16,.45);backdrop-filter:blur(3px);overflow-x:hidden}#menuPanel{position:absolute;left:50%;top:12vh;transform:translateX(-50%);width:min(960px,calc(100vw - 2rem));max-height:76vh;overflow:auto;background:rgba(24,26,32,.96);color:#e8e8ea;border:1px solid #3a3d45;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.35)}.mp-header{position:sticky;top:0;background:rgba(24,26,32,.98);z-index:1;padding:.9rem clamp(.8rem,2vw,1rem);border-bottom:1px solid #33373f;display:flex;align-items:center;justify-content:space-between}.mp-title{font-weight:700;letter-spacing:.2px}.mp-close{border:1px solid #3a3d45;background:#181a20;color:#e8e8ea;border-radius:10px;padding:.35rem .6rem;font-weight:600}.mp-body{padding:clamp(.6rem,2vw,1rem);display:grid;grid-template-columns:1fr 1fr;gap:14px}@media(max-width:860px){.mp-body{grid-template-columns:1fr}}.card{background:#15171d;border:1px solid #33373f;border-radius:12px;padding:.9rem}.card h3{margin:.1rem 0 .7rem;font-size:1rem;opacity:.95}.row{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin:.45rem 0;width:100%}.btn{border:1px solid #3a3d45;padding:.45rem .7rem;border-radius:999px;background:#181a20;color:#e8e8ea;font-weight:600;letter-spacing:.2px;cursor:pointer}.btn.active{background:#06f;border-color:#4c8dff}.tag{background:#181a20;border:1px solid #3a3d45;padding:.25rem .5rem;border-radius:999px;font-size:.82rem;white-space:nowrap;cursor:pointer}.sl{display:flex;align-items:center;gap:.6rem;flex-wrap:nowrap;width:100%;min-width:0}.sl label{font-size:.88rem;opacity:.92;flex:0 0 150px;min-width:120px;max-width:220px}.sl input[type=range]{accent-color:#4c8dff;flex:1 1 auto;min-width:0;max-width:100%;width:100%}.sl .tag{flex:0 0 auto}@media(max-width:520px){.sl{flex-wrap:wrap}.sl label{flex:1 0 100%}.sl input[type=range]{flex:1 0 100%}.sl .tag{margin-left:auto}}select{background:#181a20;color:#e8e8ea;border:1px solid #3a3d45;border-radius:10px;padding:.35rem .5rem;max-width:100%}#joyHint,#darHint{position:fixed;z-index:2;pointer-events:none;background:rgba(24,26,32,.92);border:1px solid #3a3d45;color:#cfd3dc;padding:.35rem .55rem;border-radius:10px;font-size:.85rem;white-space:nowrap;transform:translate(-50%,-50%);opacity:0;transition:opacity .25s ease}#joyHint.show,#darHint.show{opacity:1}#gizmoFrame{position:fixed;right:.6rem;top:64px;width:84px;height:84px;z-index:2;border-radius:10px;border:1px solid #3a3d45;background:rgba(24,26,32,.5);box-shadow:0 8px 24px rgba(0,0,0,.2);pointer-events:none}</style></head><body><canvas id="gl"></canvas><canvas id="hud"></canvas><div id="gizmoFrame"></div><button id="themeToggle" type="button" title="Toggle light/dark">🌙</button><button id="menuBtn" type="button" title="Open Menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button><div id="menuOverlay"><div id="menuPanel"><div class="mp-header"><div class="mp-title">L4 Controls & Settings</div><button class="mp-close" id="menuCloseBtn" type="button">Close</button></div><div class="mp-body"><div class="card"><h3>Rotation</h3><div class="row"><button id="rollL" class="btn" type="button">Air Roll Right</button><button id="rollR" class="btn active" type="button">Air Roll Left</button><button id="restart" class="btn" type="button">Restart</button><button id="orbit" class="btn" type="button">Orbit</button><button id="lockPY" class="btn" type="button">Lock Pitch/Yaw</button><span class="tag" id="lockPYTag">Off</span></div><div class="row sl"><label for="spinSlider">DAR Roll</label><input id="spinSlider" type="range" min="0" max="3.00" step="0.01" value="1.20"/><span class="tag" id="rollVal">1.20 s/rot</span></div><div class="row" style="font-size:.86rem;opacity:.85;line-height:1.35">Tip: With <b>Air Roll Right</b>, rotate the stick clockwise. With <b>Air Roll Left</b>, rotate the stick counter-clockwise.</div></div><div class="card"><h3>Dynamics</h3><div class="row sl"><label for="accelPitchRange">Max Accel Pitch (°/s²)</label><input id="accelPitchRange" type="range" min="120" max="3200" step="5" value="1440"/><span class="tag" id="accelPitchTag">1440</span></div><div class="row sl"><label for="accelYawRange">Max Accel Yaw (°/s²)</label><input id="accelYawRange" type="range" min="120" max="3200" step="5" value="1200"/><span class="tag" id="accelYawTag">1200</span></div><div class="row sl"><label for="curveRange">Input Curve</label><input id="curveRange" type="range" min="1.00" max="12.20" step="0.05" value="1.00"/><span class="tag" id="curveTag">1.00</span></div><div class="row sl"><label for="dampRange">Damp</label><input id="dampRange" type="range" min="0.00" max="24.00" step="0.05" value="5.00"/><span class="tag" id="dampTag">5.00</span></div><div class="row sl"><label for="darXRange">DAR Cross‑Damp (P/Y)</label><input id="darXRange" type="range" min="0.00" max="12.00" step="0.05" value="1.50"/><span class="tag" id="darXTag">1.50</span></div><div class="row sl"><label for="brakeRange">Release Brake</label><input id="brakeRange" type="range" min="0.00" max="32.00" step="0.10" value="6.00"/><span class="tag" id="brakeTag">6.00</span></div><div class="row sl"><label for="wmaxRange">Max ω (global)</label><input id="wmaxRange" type="range" min="6.0" max="34.0" step="0.5" value="6.0"/><span class="tag" id="wmaxTag">6.0</span></div><div class="row sl"><label for="wmaxPitch">Max Pitch ω</label><input id="wmaxPitch" type="range" min="4.0" max="34.0" step="0.5" value="8.5"/><span class="tag" id="wmaxPitchTag">8.5</span></div><div class="row sl"><label for="wmaxYaw">Max Yaw ω</label><input id="wmaxYaw" type="range" min="4.0" max="34.0" step="0.5" value="9.0"/><span class="tag" id="wmaxYawTag">9.0</span></div></div><div class="card"><h3>Car</h3><div class="row sl"><label for="presetSel">Body</label><select id="presetSel"><option value="placeholder">Placeholder (140×56×240)</option><option value="octane" selected>Octane proportions</option><option value="dominus">Dominus proportions</option></select></div></div><div class="card"><h3>View & HUD</h3><div class="row sl"><label for="zoomSlider">Zoom</label><input id="zoomSlider" type="range" min="0.70" max="1.60" step="0.01" value="1.00"/><span class="tag" id="zoomVal">1.00×</span></div><div class="row sl"><label for="stickSizeSlider">Stick Size</label><input id="stickSizeSlider" type="range" min="60" max="180" step="1" value="100"/><span class="tag" id="stickVal">100</span></div><div class="row sl"><label for="arrowSlider">Arrow Size</label><input id="arrowSlider" type="range" min="0.60" max="4.00" step="0.01" value="4.00"/><span class="tag" id="arrowVal">4.00×</span></div><div class="row"><button id="spinStickBtn" class="btn" type="button">Spin Stick (follow roll)</button><span class="tag" id="spinStickTag">Off</span></div></div><div class="card"><h3>Gamepad</h3><div class="row"><button id="gpEnable" class="btn active" type="button">Enable</button><span class="tag" id="gpStatus">Enabled (waiting for gamepad)</span></div><div class="row sl"><label for="gpPreset">Preset</label><select id="gpPreset"><option value="ps5" selected>PS5 / DualSense</option><option value="xinput">Generic XInput</option></select></div><div class="row"><button id="gpRemap" class="btn" type="button">Remap Action…</button><select id="gpAction"><option value="toggleDAR">Toggle DAR</option><option value="rollLeft">Air Roll Left</option><option value="rollRight">Air Roll Right</option><option value="restart">Restart</option><option value="orbitToggle">Toggle Orbit</option></select><span class="tag" id="gpBindLabel">—</span></div><div class="row" style="font-size:.86rem;opacity:.85;line-height:1.35">Tip: Left stick moves the on-screen stick. Remap any action, then press a button or push an axis to bind.</div></div></div></div></div><div id="joyHint">Hold outside the stick to reposition (UI hidden)</div><div id="darHint">Tap to toggle roll • Hold to move</div><script type="module">import * as THREE from "https://esm.sh/three@0.155.0";import{GLTFLoader}from"https://esm.sh/three@0.155.0/examples/jsm/loaders/GLTFLoader.js";const gl=document.getElementById("gl"),hud=document.getElementById("hud"),renderer=new THREE.WebGLRenderer({canvas:gl,antialias:!0});renderer.outputColorSpace=THREE.SRGBColorSpace;renderer.setPixelRatio(Math.min(devicePixelRatio,2));renderer.setSize(innerWidth,innerHeight);const scene=new THREE.Scene();scene.fog=new THREE.Fog(0xeef1f6,900,2600);const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,.1,5e3),CAM_BASE={y:280,z:760};camera.position.set(0,CAM_BASE.y,CAM_BASE.z);scene.add(camera);renderer.toneMappingExposure=1.45;const amb=new THREE.AmbientLight(0xffffff,1.35),dir=new THREE.DirectionalLight(0xffffff,1.5);dir.position.set(-350,700,900);dir.castShadow=!1;const fill=new THREE.DirectionalLight(0xffffff,1.05);fill.position.set(600,300,-400);const rim=new THREE.DirectionalLight(0xffffff,.85);rim.position.set(-900,450,-700);scene.add(amb,dir,fill,rim);const grid=new THREE.Group,gridMain=new THREE.GridHelper(2600,26,0xd7dde6,0xE5E9F1);gridMain.material.opacity=.72;gridMain.material.transparent=!0;grid.add(gridMain);grid.rotation.x=-Math.PI/2;grid.position.y=-160;scene.add(grid);const THEMES={light:{fog:0xeef1f6,gridLine:0xE5E9F1,gridCenter:0xd7dde6,bodyClass:""},dark:{fog:0x101318,gridLine:0x1f232b,gridCenter:0x2a2e36,bodyClass:"theme-dark"}};function setGridColors(e,t){const a=gridMain.material;Array.isArray(a)?(a[0]?.color?.setHex(t),a[1]?.color?.setHex(e)):a?.color?.setHex(e)}function applyTheme(e){const t=THEMES[e]||THEMES.light;document.body.classList.toggle("theme-dark","theme-dark"===t.bodyClass),scene.fog?scene.fog.color.setHex(t.fog):scene.fog=new THREE.Fog(t.fog,900,2600),setGridColors(t.gridLine,t.gridCenter);const a=document.getElementById("themeToggle");a&&(a.textContent="dark"===e?"☀️":"🌙");try{localStorage.setItem("l4_theme",e)}catch{}}function initTheme(){let e="light";try{e=localStorage.getItem("l4_theme")||"light"}catch{}applyTheme(e)}document.getElementById("themeToggle")?.addEventListener("click",()=>{const e="dark"===localStorage.getItem("l4_theme")?"light":"dark";applyTheme(e)}),initTheme();const COL_UP=16731932,COL_RIGHT=5024767,COL_DOWN=5485801,COL_LEFT=16762374,MAT_BODY=new THREE.MeshPhongMaterial({color:0xdfe5ef,shininess:50,specular:6710886}),MAT_GLASS=new THREE.MeshPhongMaterial({color:0x9aa6b7,shininess:40,specular:2236962,transparent:!0,opacity:.65}),MAT_ACCENT=new THREE.MeshPhongMaterial({color:0xcbd3df,shininess:35,specular:2236962}),MAT_DARK=new THREE.MeshPhongMaterial({color:0xaeb7c4,shininess:28,specular:2236962}),MAT_EDGE=e=>new THREE.LineBasicMaterial({color:e}),MAT_TIRE_F=new THREE.MeshLambertMaterial({color:0x8a93a0}),MAT_TIRE_B=new THREE.MeshLambertMaterial({color:0x808896}),MAT_HUB=new THREE.MeshBasicMaterial({color:0x5a6270}),presets={placeholder:{hx:70,hy:28,hz:120},octane:{hx:85.65,hy:36.8,hz:120},dominus:{hx:77.9,hy:29.3,hz:120}};let car=null,BOX=null,faceArrow=null,faceTip=null;const FACE_OFFSET=0,FACE_EPS=.05;function clearCar(){car&&(scene.remove(car),car.traverse(o=>{o.geometry&&o.geometry.dispose(),o.material&&o.material.dispose?.()}),car=null)}function buildCar(e,t="placeholder"){clearCar(),BOX=e,car=new THREE.Group,car.position.y=110,scene.add(car);const a=new THREE.Mesh(new THREE.BoxGeometry(2*BOX.hx,2*BOX.hy,2*BOX.hz),MAT_BODY);car.add(a),"octane"===t?buildOctane():"dominus"===t?buildDominus():buildPlaceholderFancy();const n=new THREE.Vector3(-BOX.hx,+BOX.hy,+BOX.hz),r=new THREE.Vector3(+BOX.hx,+BOX.hy,+BOX.hz),i=new THREE.Vector3(+BOX.hx,-BOX.hy,+BOX.hz),s=new THREE.Vector3(-BOX.hx,-BOX.hy,+BOX.hz);addEdge(r,n,COL_UP),addEdge(i,r,COL_LEFT),addEdge(s,i,COL_DOWN),addEdge(n,s,COL_RIGHT);const l=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,.55*BOX.hz)]),d=new THREE.Line(l,new THREE.LineBasicMaterial({color:COL_DOWN}));car.add(d);const c=new THREE.Mesh(new THREE.ConeGeometry(8,16,12),new THREE.MeshBasicMaterial({color:COL_DOWN}));c.rotation.x=Math.PI/2,c.position.z=.55*BOX.hz+10,car.add(c);const x=BOX.hx-10,g=.68*BOX.hz;addWheel(+x,-g),addWheel(-x,-g),addWheel(+x,+g),addWheel(-x,+g);const p=BOX.hz+FACE_OFFSET,m=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,p+FACE_EPS),new THREE.Vector3(0,0,p+FACE_EPS)]);faceArrow=new THREE.Line(m,new THREE.LineBasicMaterial({color:3355443})),car.add(faceArrow),faceTip=new THREE.Mesh(new THREE.ConeGeometry(6,12,12),new THREE.MeshBasicMaterial({color:3355443})),faceTip.position.set(0,0,p+FACE_EPS),car.add(faceTip),faceArrow.visible=!1,faceTip.visible=!1}function addEdge(e,t,a){const n=new THREE.BufferGeometry().setFromPoints([e,t]),r=new THREE.Line(n,MAT_EDGE(a));car.add(r)}function addWheel(e,t,a=18,n=12){const r=new THREE.CylinderGeometry(a,a,n,16),i=new THREE.Mesh(r,MAT_TIRE_F),s=new THREE.Mesh(r,MAT_TIRE_B);i.rotation.z=Math.PI/2,s.rotation.z=Math.PI/2;const l=-BOX.hy-.55*a;i.position.set(e,l,t+n/2),s.position.set(e,l,t-n/2);const d=new THREE.Mesh(new THREE.CylinderGeometry(.35*a,.35*a,.6*n,10),MAT_HUB);d.rotation.z=Math.PI/2,d.position.set(e,l,t);const c=new THREE.Group;c.add(s,i,d),car.add(c)}function addCabin(e,t,a,n,r){const i=new THREE.Mesh(new THREE.BoxGeometry(e,t,a),MAT_GLASS);i.position.set(0,n,r),car.add(i)}function addSpoiler(e,t,a,n,r){const i=new THREE.Mesh(new THREE.BoxGeometry(e,t,a),MAT_ACCENT);i.position.set(0,n,r);const s=new THREE.Mesh(new THREE.BoxGeometry(t,.5*n,t),MAT_ACCENT),l=s.clone();s.position.set(-.35*e,.25*n,r-.2*a),l.position.set(.35*e,.25*n,r-.2*a),car.add(i,s,l)}function addBumper(e,t,a,n,r){const i=new THREE.Mesh(new THREE.BoxGeometry(e,t,a),MAT_DARK);i.position.set(0,n,r),car.add(i)}function addFlares(e,t,a=10,n=6){const r=new THREE.CylinderGeometry(a,a,n,10,1,!1,0,Math.PI),i=MAT_ACCENT,s=-BOX.hy+.2*a;!function(l,d,c){const x=new THREE.Mesh(r,i);x.rotation.z=Math.PI/2,x.rotation.y=c?Math.PI:0,x.position.set(l,s,d),car.add(x)}(+e,+t,!1),function(l,d,c){const x=new THREE.Mesh(r,i);x.rotation.z=Math.PI/2,x.rotation.y=c?Math.PI:0,x.position.set(l,s,d),car.add(x)}(-e,+t,!0),function(l,d,c){const x=new THREE.Mesh(r,i);x.rotation.z=Math.PI/2,x.rotation.y=c?Math.PI:0,x.position.set(l,s,d),car.add(x)}(+e,-t,!0),function(l,d,c){const x=new THREE.Mesh(r,i);x.rotation.z=Math.PI/2,x.rotation.y=c?Math.PI:0,x.position.set(l,s,d),car.add(x)}(-e,-t,!1)}function buildPlaceholderFancy(){const e=BOX.hx-10,t=.68*BOX.hz;addFlares(e,t,10,6),addCabin(1*BOX.hx,.9*BOX.hy,.55*BOX.hz,.65*BOX.hy,-.1*BOX.hz),addSpoiler(1*BOX.hx,6,24,.8*BOX.hy,-.95*BOX.hz),addBumper(.9*BOX.hx,10,18,-.7*BOX.hy,.98*BOX.hz)}function buildOctane(){const e=BOX.hx-6,t=.64*BOX.hz;addWheel(+e,-t,19,12),addWheel(-e,-t,19,12),addWheel(+e,+t,18,12),addWheel(-e,+t,18,12),addFlares(e,t,12,7),addCabin(.95*BOX.hx,1.1*BOX.hy,.6*BOX.hz,.85*BOX.hy,-.05*BOX.hz),addSpoiler(1.2*BOX.hx,6,30,.9*BOX.hy,-1.02*BOX.hz),addBumper(.85*BOX.hx,12,20,-.6*BOX.hy,1.02*BOX.hz)}function buildDominus(){const e=BOX.hx-8,t=.7*BOX.hz;addWheel(+e,-t,18,12),addWheel(-e,-t,18,12),addWheel(+e,+t,18,12),addWheel(-e,+t,18,12),addFlares(e,t,11,6),addCabin(1.05*BOX.hx,.75*BOX.hy,.75*BOX.hz,.6*BOX.hy,-.05*BOX.hz),addSpoiler(.9*BOX.hx,5,18,.72*BOX.hy,-1*BOX.hz),addBumper(1.05*BOX.hx,10,30,-.55*BOX.hy,1.05*BOX.hz)}function applySpawnOrientation(){car&&car.rotation.set(-Math.PI/2,0,Math.PI)}const hctx=hud.getContext("2d");function sizeHud(){hud.width=innerWidth,hud.height=innerHeight}function Hclear(){hctx.setTransform(1,0,0,1,0,0),hctx.clearRect(0,0,hud.width,hud.height)}function Hcircle(e,t,a,n,r){hctx.beginPath(),hctx.lineWidth=r,hctx.strokeStyle=n,hctx.arc(e,t,a,0,2*Math.PI),hctx.stroke()}function HfillCircle(e,t,a,n){hctx.beginPath(),hctx.fillStyle=n,hctx.arc(e,t,a,0,2*Math.PI),hctx.fill()}function Harc(e,t,a,n,r,i,s){hctx.beginPath(),hctx.lineWidth=s,hctx.strokeStyle=i,hctx.arc(e,t,a,n,r),hctx.stroke()}function Hline(e,t,a,n,r,i){hctx.beginPath(),hctx.lineWidth=i,hctx.strokeStyle=r,hctx.moveTo(e,t),hctx.lineTo(a,n),hctx.stroke()}function Htri(e,t,a,n,r){hctx.save(),hctx.translate(e,t),hctx.rotate(a),hctx.beginPath(),hctx.moveTo(0,-n),hctx.lineTo(.9*n,.9*n),hctx.lineTo(-.9*n,.9*n),hctx.closePath(),hctx.fillStyle=r,hctx.fill(),hctx.restore()}sizeHud();let spinStick=!1,stickAngle=0,JOY_BASE_R=100,JOY_KNOB_R=Math.round(.32*JOY_BASE_R),JOY_CENTER=new THREE.Vector2(126,innerHeight-170),joyActive=!1,joyVec=new THREE.Vector2(0,0),smJoy=new THREE.Vector2(0,0);const STICK_TAU_MS=8,RELOCATE_HOLD_MS=250,STICK_MIN=.02;let activeId=null,relocating=!1,holdTimer=null;const COLS={UP:"#ff5c5c",RIGHT:"#4c8dff",DOWN:"#53d769",LEFT:"#ffd166"};function drawJoystick(){const e=JOY_CENTER.x,t=JOY_CENTER.y,a=JOY_BASE_R;spinStick&&(hctx.save(),hctx.translate(e,t),hctx.rotate(-stickAngle),hctx.translate(-e,-t));const n=performance.now(),r=1+.06*Math.sin(.008*n),i=a*r+10;Hcircle(e,t,i,"rgba(76,141,255,0.28)",8),Harc(e,t,a,-Math.PI/4,Math.PI/4,COLS.RIGHT,12),Harc(e,t,a,Math.PI/4,3*Math.PI/4,COLS.UP,12),Harc(e,t,a,3*Math.PI/4,5*Math.PI/4,COLS.LEFT,12),Harc(e,t,a,5*Math.PI/4,7*Math.PI/4,COLS.DOWN,12),Hcircle(e,t,a-18,"#b9c1cd",2),Hline(e-a+12,t,e+a-12,t,"#cfd6e2",1.5),Hline(e,t-a+12,e,t+a-12,"#cfd6e2",1.5);const s=e+joyVec.x,l=t+joyVec.y;Hcircle(s,l,JOY_KNOB_R,"#4c8dff",4),HfillCircle(s,l,JOY_KNOB_R,"#0f1116"),hctx.fillStyle="#222",hctx.beginPath(),hctx.arc(e,t,3,0,2*Math.PI),hctx.fill(),spinStick&&hctx.restore()}function inJoyLoose(e,t){const a=e-JOY_CENTER.x,n=t-JOY_CENTER.y,r=JOY_BASE_R+28,i=a*a+n*n<=r*r,s=Math.abs(a)<=JOY_BASE_R&&Math.abs(n)<=JOY_BASE_R+40;return i||s}function vecFromJoyPx(e,t){let a=e-JOY_CENTER.x,n=t-JOY_CENTER.y;const r=Math.hypot(a,n);if(r>JOY_BASE_R){const i=JOY_BASE_R/(r||1);a*=i,n*=i}return new THREE.Vector2(a,n)}function clampJoyCenter(){JOY_CENTER.x=Math.max(JOY_BASE_R+20,Math.min(innerWidth-(JOY_BASE_R+20),JOY_CENTER.x)),JOY_CENTER.y=Math.max(JOY_BASE_R+20,Math.min(innerHeight-(JOY_BASE_R+20),JOY_CENTER.y))}let DAR_R=44,DAR_CENTER=new THREE.Vector2(innerWidth-120,innerHeight-150),darOn=!1,darRelocating=!1,darHoldTimer=null,darPressT=0;function drawDAR(){const e=DAR_CENTER.x,t=DAR_CENTER.y,a=DAR_R;HfillCircle(e,t,a,darOn?"rgba(0,102,255,0.18)":"rgba(24,26,32,0.75)"),Hcircle(e,t,a,darOn?"#4c8dff":"#3a3d45",darOn?5:3);const n=airRoll>0?Math.PI/2:-Math.PI/2;Htri(e,t,n,.55*a,darOn?"#0e0f12":"#e8e8ea"),Hcircle(e,t,a-12,"#bdbdbd",1.5)}function inDAR(e,t){const a=e-DAR_CENTER.x,n=t-DAR_CENTER.y;return a*a+n*n<=DAR_R*DAR_R}function clampDARCenter(){const e=DAR_R+20;DAR_CENTER.x=Math.max(e,Math.min(innerWidth-e,DAR_CENTER.x)),DAR_CENTER.y=Math.max(e,Math.min(innerHeight-e,DAR_CENTER.y))}const joyHint=document.getElementById("joyHint"),darHint=document.getElementById("darHint");function showHint(e,t){e.classList.add("show"),setTimeout(()=>e.classList.remove("show"),t)}function positionHints(){joyHint.style.left=JOY_CENTER.x+JOY_BASE_R+18+"px",joyHint.style.top=JOY_CENTER.y-JOY_BASE_R-18+"px",darHint.style.left=DAR_CENTER.x+DAR_R+18+"px",darHint.style.top=DAR_CENTER.y-DAR_R-18+"px"}const menuBtn=document.getElementById("menuBtn"),menuOverlay=document.getElementById("menuOverlay"),menuCloseBtn=document.getElementById("menuCloseBtn");let chromeShown=!1;function openMenu(){chromeShown=!0,menuBtn.classList.add("active"),menuOverlay.style.display="block"}function closeMenu(){chromeShown=!1,menuBtn.classList.remove("active"),menuOverlay.style.display="none"}menuBtn.addEventListener("click",()=>chromeShown?closeMenu():openMenu()),menuCloseBtn.addEventListener("click",closeMenu),menuOverlay.addEventListener("click",e=>{e.target===menuOverlay&&closeMenu()});let airRoll=-1,lockPitchYaw=!1;function setRoll(e){airRoll=e,document.getElementById("rollL").classList.toggle("active",e>0),document.getElementById("rollR").classList.toggle("active",e<0)}document.getElementById("rollL").addEventListener("click",()=>setRoll(1)),document.getElementById("rollR").addEventListener("click",()=>setRoll(-1)),document.getElementById("lockPY").addEventListener("click",()=>{lockPitchYaw=!lockPitchYaw,document.getElementById("lockPY").classList.toggle("active",lockPitchYaw),document.getElementById("lockPYTag").textContent=lockPitchYaw?"On":"Off"}),document.getElementById("restart").addEventListener("click",()=>{car&&car.quaternion.identity(),applySpawnOrientation(),w.set(0,0,0),stickAngle=0,orbitOn=!1,document.getElementById("orbit").classList.remove("active"),orbitPhase=0,camera.position.set(0,220,650),camera.lookAt(0,0,0),faceArrow&&(faceArrow.visible=!1),faceTip&&(faceTip.visible=!1)});let orbitOn=!1;document.getElementById("orbit").addEventListener("click",()=>{orbitOn=!orbitOn,document.getElementById("orbit").classList.toggle("active",orbitOn)});const accelPitchRange=document.getElementById("accelPitchRange"),accelPitchTag=document.getElementById("accelPitchTag"),accelYawRange=document.getElementById("accelYawRange"),accelYawTag=document.getElementById("accelYawTag"),curveRange=document.getElementById("curveRange"),curveTag=document.getElementById("curveTag"),dampRange=document.getElementById("dampRange"),dampTag=document.getElementById("dampTag"),darXRange=document.getElementById("darXRange"),darXTag=document.getElementById("darXTag"),brakeRange=document.getElementById("brakeRange"),brakeTag=document.getElementById("brakeTag"),wmaxRange=document.getElementById("wmaxRange"),wmaxTag=document.getElementById("wmaxTag"),wmaxPitchRange=document.getElementById("wmaxPitch"),wmaxPitchTag=document.getElementById("wmaxPitchTag"),wmaxYawRange=document.getElementById("wmaxYaw"),wmaxYawTag=document.getElementById("wmaxYawTag"),spinSlider=document.getElementById("spinSlider"),rollVal=document.getElementById("rollVal"),sizeSlider=document.getElementById("stickSizeSlider"),stickVal=document.getElementById("stickVal"),zoomSlider=document.getElementById("zoomSlider"),zoomVal=document.getElementById("zoomVal"),arrowSlider=document.getElementById("arrowSlider"),arrowVal=document.getElementById("arrowVal"),presetSel=document.getElementById("presetSel"),spinStickBtn=document.getElementById("spinStickBtn"),spinStickTag=document.getElementById("spinStickTag");let maxAccelPitchDeg=parseFloat(accelPitchRange.value),maxAccelYawDeg=parseFloat(accelYawRange.value),inputPow=parseFloat(curveRange.value),damp=parseFloat(dampRange.value),darX=parseFloat(darXRange.value),brakeOnRelease=parseFloat(brakeRange.value),wMax=parseFloat(wmaxRange.value),wMaxPitch=parseFloat(wmaxPitchRange.value),wMaxYaw=parseFloat(wmaxYawRange.value),freeRollPeriod=parseFloat(spinSlider.value),zoom=parseFloat(zoomSlider.value),arrowScale=parseFloat(arrowSlider.value);function syncTags(){accelPitchTag.textContent=maxAccelPitchDeg.toFixed(0),accelYawTag.textContent=maxAccelYawDeg.toFixed(0),curveTag.textContent=inputPow.toFixed(2),dampTag.textContent=damp.toFixed(2),darXTag.textContent=darX.toFixed(2),brakeTag.textContent=brakeOnRelease.toFixed(1),wmaxTag.textContent=wMax.toFixed(1),wmaxPitchTag.textContent=wMaxPitch.toFixed(1),wmaxYawTag.textContent=wMaxYaw.toFixed(1),rollVal.textContent=freeRollPeriod>0?freeRollPeriod.toFixed(2)+" s/rot":"off",stickVal.textContent=String(Math.round(JOY_BASE_R)),zoomVal.textContent=(zoom||1).toFixed(2)+"×",arrowVal.textContent=(arrowScale||1).toFixed(2)+"×",spinStickTag.textContent=spinStick?"On":"Off"}syncTags(),accelPitchRange.addEventListener("input",()=>{maxAccelPitchDeg=parseFloat(accelPitchRange.value)||1440,syncTags()}),accelYawRange.addEventListener("input",()=>{maxAccelYawDeg=parseFloat(accelYawRange.value)||1200,syncTags()}),curveRange.addEventListener("input",()=>{inputPow=parseFloat(curveRange.value)||1,syncTags()}),dampRange.addEventListener("input",()=>{damp=parseFloat(dampRange.value)||0,syncTags()}),darXRange.addEventListener("input",()=>{darX=parseFloat(darXRange.value)||0,syncTags()}),brakeRange.addEventListener("input",()=>{brakeOnRelease=parseFloat(brakeRange.value)||0,syncTags()}),wmaxRange.addEventListener("input",()=>{wMax=parseFloat(wmaxRange.value)||6,syncTags()}),wmaxPitchRange.addEventListener("input",()=>{wMaxPitch=parseFloat(wmaxPitchRange.value)||8.5,syncTags()}),wmaxYawRange.addEventListener("input",()=>{wMaxYaw=parseFloat(wmaxYawRange.value)||9,syncTags()}),spinSlider.addEventListener("input",()=>{freeRollPeriod=parseFloat(spinSlider.value)||0,syncTags()}),sizeSlider.addEventListener("input",()=>{JOY_BASE_R=parseInt(sizeSlider.value,10)||100,JOY_KNOB_R=Math.round(.32*JOY_BASE_R),clampJoyCenter(),positionHints(),syncTags()}),zoomSlider.addEventListener("input",()=>{zoom=parseFloat(zoomSlider.value)||1,applyZoom(),syncTags()}),arrowSlider.addEventListener("input",()=>{arrowScale=parseFloat(arrowSlider.value)||4,syncTags()}),presetSel.addEventListener("change",()=>{const e=presetSel.value;buildCar(presets[e],e),car.quaternion.identity(),w.set(0,0,0),stickAngle=0,applySpawnOrientation()}),spinStickBtn.addEventListener("click",()=>{spinStick=!spinStick,spinStickBtn.classList.toggle("active",spinStick),syncTags()});function makeTagEditable(e,get,set,fmt){e?.addEventListener("click",()=>{const v=prompt("Enter value",fmt());if(null==v)return;const n=parseFloat(v);if(!isFinite(n))return;set(n),syncTags()})}makeTagEditable(accelPitchTag,()=>maxAccelPitchDeg, n=>{maxAccelPitchDeg=n,accelPitchRange.value=String(n)},()=>String(maxAccelPitchDeg));makeTagEditable(accelYawTag,()=>maxAccelYawDeg, n=>{maxAccelYawDeg=n,accelYawRange.value=String(n)},()=>String(maxAccelYawDeg));makeTagEditable(dampTag,()=>damp, n=>{damp=n,dampRange.value=String(n.toFixed(2))},()=>damp.toFixed(2));makeTagEditable(darXTag,()=>darX, n=>{darX=n,darXRange.value=String(n.toFixed(2))},()=>darX.toFixed(2));makeTagEditable(brakeTag,()=>brakeOnRelease, n=>{brakeOnRelease=n,brakeRange.value=String(n.toFixed(1))},()=>brakeOnRelease.toFixed(1));makeTagEditable(wmaxTag,()=>wMax, n=>{wMax=n,wmaxRange.value=String(n.toFixed(1))},()=>wMax.toFixed(1));makeTagEditable(wmaxPitchTag,()=>wMaxPitch, n=>{wMaxPitch=n,wmaxPitchRange.value=String(n.toFixed(1))},()=>wMaxPitch.toFixed(1));makeTagEditable(wmaxYawTag,()=>wMaxYaw, n=>{wMaxYaw=n,wmaxYawRange.value=String(n.toFixed(1))},()=>wMaxYaw.toFixed(1));makeTagEditable(stickVal,()=>JOY_BASE_R, n=>{JOY_BASE_R=Math.max(60,Math.min(180,Math.round(n))),sizeSlider.value=String(JOY_BASE_R),JOY_KNOB_R=Math.round(.32*JOY_BASE_R),clampJoyCenter(),positionHints()},()=>String(JOY_BASE_R));makeTagEditable(zoomVal,()=>zoom, n=>{zoom=Math.max(.7,Math.min(1.6,n)),zoomSlider.value=String(zoom.toFixed(2)),applyZoom()},()=>zoom.toFixed(2));makeTagEditable(arrowVal,()=>arrowScale, n=>{arrowScale=Math.max(.6,Math.min(4,n)),arrowSlider.value=String(arrowScale.toFixed(2))},()=>arrowScale.toFixed(2));hud.addEventListener("pointerdown",e=>{try{hud.setPointerCapture(e.pointerId)}catch{}if(activeId=e.pointerId,inDAR(e.clientX,e.clientY))return darPressT=performance.now(),clearTimeout(darHoldTimer),darHoldTimer=setTimeout(()=>{activeId===e.pointerId&&(darRelocating=!0,showHint(darHint,2e3))},RELOCATE_HOLD_MS),void e.preventDefault();inJoyLoose(e.clientX,e.clientY)?(joyActive=!0,joyVec=vecFromJoyPx(e.clientX,e.clientY)):chromeShown||(clearTimeout(holdTimer),holdTimer=setTimeout(()=>{activeId===e.pointerId&&!chromeShown&&(relocating=!0,showHint(joyHint,1800))},RELOCATE_HOLD_MS)),e.preventDefault()},{passive:!1}),hud.addEventListener("pointermove",e=>{activeId===e.pointerId&&(darRelocating?(DAR_CENTER.set(e.clientX,e.clientY),clampDARCenter(),positionHints()):relocating?(JOY_CENTER.set(e.clientX,e.clientY),clampJoyCenter(),positionHints()):joyActive&&(joyVec=vecFromJoyPx(e.clientX,e.clientY))),e.preventDefault()},{passive:!1});function endPtr(e){if(activeId!==e.pointerId)return;try{hud.releasePointerCapture(e.pointerId)}catch{}if(clearTimeout(holdTimer),relocating=!1,!darRelocating&&inDAR(e.clientX,e.clientY)){const t=performance.now()-darPressT;t<RELOCATE_HOLD_MS&&(darOn=!darOn)}clearTimeout(darHoldTimer),darRelocating=!1,joyActive&&(joyActive=!1,joyVec.set(0,0)),activeId=null,e.preventDefault()}hud.addEventListener("pointerup",endPtr,{passive:!1}),hud.addEventListener("pointercancel",endPtr,{passive:!1});const gpEnableBtn=document.getElementById("gpEnable"),gpStatusTag=document.getElementById("gpStatus"),gpPresetSel=document.getElementById("gpPreset"),gpActionSel=document.getElementById("gpAction"),gpRemapBtn=document.getElementById("gpRemap"),gpBindLabel=document.getElementById("gpBindLabel");let gpEnabled=!0,gpIndex=-1,gpRemapping=!1,gpPrevActionPressed={},gpBindings={toggleDAR:{kind:"button",index:1},rollLeft:{kind:"button",index:4},rollRight:{kind:"button",index:5},restart:{kind:"button",index:9},orbitToggle:{kind:"button",index:2}},GP_PRESETS={ps5:{toggleDAR:{kind:"button",index:1},rollLeft:{kind:"button",index:4},rollRight:{kind:"button",index:5},restart:{kind:"button",index:9},orbitToggle:{kind:"button",index:2}},xinput:{toggleDAR:{kind:"button",index:1},rollLeft:{kind:"button",index:4},rollRight:{kind:"button",index:5},restart:{kind:"button",index:9},orbitToggle:{kind:"button",index:2}}};function bindingToLabel(e){if(!e)return"—";if("button"===e.kind)return`Button ${e.index}`;const t=e.dir>0?"+":"−";return`Axis ${e.axis}${t}`}function setBindingPreset(e){const t=GP_PRESETS[e]||GP_PRESETS.ps5;gpBindings=JSON.parse(JSON.stringify(t)),updateBindLabel()}function updateBindLabel(){const e=gpActionSel.value;gpBindLabel.textContent=bindingToLabel(gpBindings[e])}gpEnableBtn.addEventListener("click",()=>{gpEnabled=!gpEnabled,gpEnableBtn.classList.toggle("active",gpEnabled),gpStatusTag.textContent=gpEnabled?"Enabled":"Disabled"}),gpPresetSel.addEventListener("change",(()=>setBindingPreset(gpPresetSel.value))),gpActionSel.addEventListener("change",updateBindLabel),gpRemapBtn.addEventListener("click",()=>{gpRemapping=!0,gpBindLabel.textContent="Press button / move axis…"}),setBindingPreset("ps5"),updateBindLabel(),addEventListener("gamepadconnected",e=>{gpIndex<0&&(gpIndex=e.gamepad.index),gpStatusTag.textContent=`Connected: ${e.gamepad.id}`}),addEventListener("gamepaddisconnected",e=>{e.gamepad.index===gpIndex&&(gpIndex=-1),gpStatusTag.textContent=gpEnabled?"Enabled (waiting for gamepad)":"No gamepad"});function readPads(){const e=navigator.getGamepads?.()||[];gpIndex<0&&(()=>{for(let t=0;t<e.length;t++){const a=e[t];if(a&&"standard"===a.mapping){gpIndex=t;break}}})()}function isPressedForBinding(e,t){if(!t||!e)return!1;if("button"===t.kind){const a=e.buttons[t.index];return!!(a&&(a.value||0)>.5)}if("axis"===t.kind){const a=e.axes[t.axis]||0;return t.dir>0?a>.6:a<-.6}return!1}function execBinding(e){switch(e){case"toggleDAR":darOn=!darOn;break;case"rollLeft":setRoll(-1);break;case"rollRight":setRoll(1);break;case"restart":car&&car.quaternion.identity(),applySpawnOrientation(),w.set(0,0,0),stickAngle=0,orbitOn=!1,document.getElementById("orbit").classList.remove("active"),orbitPhase=0,camera.position.set(0,220,650),camera.lookAt(0,0,0),faceArrow&&(faceArrow.visible=!1),faceTip&&(faceTip.visible=!1);break;case"orbitToggle":orbitOn=!orbitOn,document.getElementById("orbit").classList.toggle("active",orbitOn)}}function handleRemap(e){if(!gpRemapping||!e)return;for(let t=0;t<e.buttons.length;t++)if(e.buttons[t]&&(e.buttons[t].value||0)>.5){gpBindings[gpActionSel.value]={kind:"button",index:t},gpRemapping=!1,updateBindLabel();return}for(let t=0;t<e.axes.length;t++){const a=e.axes[t]||0;if(Math.abs(a)>.6){gpBindings[gpActionSel.value]={kind:"axis",axis:t,dir:a>0?1:-1},gpRemapping=!1,updateBindLabel();return}}}function updateGamepadInput(){if(!gpEnabled)return;const e=navigator.getGamepads?.()[gpIndex];readPads();const t=e;t?gpStatusTag.textContent=`Connected: ${t.id}`:gpStatusTag.textContent=gpEnabled?"Enabled (waiting for gamepad)":"No gamepad",gpRemapping&&handleRemap(t),t&&!joyActive&&!relocating&&!darRelocating&&(()=>{const a=t.axes[0]||0,n=t.axes[1]||0,r=Math.hypot(a,n);let i=0,s=0;if(r>.15){const l=(r-.15)/(1-.15);i=a/(r||1)*l,s=n/(r||1)*l}joyVec.set(i*JOY_BASE_R,s*JOY_BASE_R)})(),t&&Object.keys(gpBindings).forEach(a=>{const n=isPressedForBinding(t,gpBindings[a]),r=!!gpPrevActionPressed[a];n&&!r&&execBinding(a),gpPrevActionPressed[a]=n})}let w=new THREE.Vector3(0,0,0);const STICK_DEADZONE=STICK_MIN,KP_ROLL=6;function integrate(e){const t=1-Math.exp(-(1e3*e)/Math.max(1,STICK_TAU_MS));smJoy.lerp(joyVec,t);const a=smJoy.x/JOY_BASE_R,n=-smJoy.y/JOY_BASE_R,r=Math.hypot(a,n);let i=Math.max(0,r-STICK_DEADZONE)/(1-STICK_DEADZONE);i=Math.pow(i,inputPow);const s=r>0?-a/r:0,l=r>0?n/r:0; if(faceArrow&&faceTip){const u=i>.02;faceArrow.visible=u,faceTip.visible=u;if(u){const o=Math.min(BOX.hx,BOX.hy)*.95,f=Math.max(10,o*i*(arrowScale||1)),h=BOX.hz+FACE_OFFSET,x=s*f,y=-l*f,pa=faceArrow.geometry.attributes.position.array;pa[0]=0,pa[1]=0,pa[2]=h+FACE_EPS,pa[3]=x,pa[4]=y,pa[5]=h+FACE_EPS,faceArrow.geometry.attributes.position.needsUpdate=!0;const col=Math.abs(x)>Math.abs(y)?x>=0?COL_LEFT:COL_RIGHT:l>=0?COL_DOWN:COL_UP;faceArrow.material.color.setHex(col),faceTip.material.color.setHex(col),faceTip.position.set(x,y,h+FACE_EPS);const ang=Math.atan2(x,-y)+Math.PI;faceTip.rotation.set(0,0,ang);const sc=.95*(arrowScale||1);faceTip.scale.set(sc,sc,1)}}const maxAccelPitchRad=maxAccelPitchDeg*Math.PI/180,maxAccelYawRad=maxAccelYawDeg*Math.PI/180;const darActive=darOn&&freeRollPeriod>0;const targetWz=darActive?airRoll*2*Math.PI/freeRollPeriod:0; const PYscale = darActive ? 0.5 : 1; let alphaX= lockPitchYaw?0:maxAccelPitchRad*i*l*PYscale; let alphaY= lockPitchYaw?0:maxAccelYawRad*i*s*PYscale; let alphaZ=0; if(darActive){alphaZ+=KP_ROLL*(targetWz - w.z);} // integrate ω: w += alpha*dt w.x+=alphaX*e; w.y+=alphaY*e; w.z+=alphaZ*e; // damping paths const noStick=i<.02; if(darActive){const k=Math.exp(-(darX||0)*e); w.x*=k; w.y*=k; // no roll damping while DAR on } else {let dEff=(damp||0)+((noStick&&!darActive)?(brakeOnRelease||0):0); const k=Math.exp(-dEff*e); w.multiplyScalar(k);} // caps if(Math.abs(w.x)>wMaxPitch) w.x=Math.sign(w.x)*wMaxPitch; if(Math.abs(w.y)>wMaxYaw) w.y=Math.sign(w.y)*wMaxYaw; if(!darActive){const wm=w.length(); if(wm>wMax) w.multiplyScalar(wMax/(wm||1));} // integrate quaternion const wx=w.x,wy=w.y,wz=w.z,halfdt=.5*e,q=car.quaternion,rw=-q.x*wx-q.y*wy-q.z*wz,rx=q.w*wx+q.y*wz-q.z*wy,ry=q.w*wy+q.z*wx-q.x*wz,rz=q.w*wz+q.x*wy-q.y*wx;q.w+=rw*halfdt,q.x+=rx*halfdt,q.y+=ry*halfdt,q.z+=rz*halfdt,q.normalize(),spinStick&&(stickAngle+=w.z*e)}let orbitPhase=0;function applyZoom(){const e=Math.max(.7,Math.min(1.6,zoom||1)),t=CAM_BASE.z/e,a=CAM_BASE.y/e;orbitOn||(camera.position.set(0,a,t),camera.lookAt(0,car?car.position.y:0,0))}function orbitStep(e){const t=Math.max(.7,Math.min(1.6,zoom||1)),a=CAM_BASE.z/t,n=CAM_BASE.y/t,r=.35,i=Math.sin(r*e)*a,s=Math.cos(r*e)*a;camera.position.set(i,n,s),camera.lookAt(0,car?car.position.y:0,0)}const gizmoRect=document.getElementById("gizmoFrame").getBoundingClientRect(),gizmoScene=new THREE.Scene,gizmoCam=new THREE.PerspectiveCamera(40,gizmoRect.width/gizmoRect.height,.1,100);gizmoCam.position.set(0,0,6);const gizmoAxes=new THREE.AxesHelper(3.2);gizmoScene.add(gizmoAxes);const gizmoTarget=new THREE.Object3D;gizmoScene.add(gizmoTarget),gizmoAxes.position.copy(gizmoTarget.position);function renderHUD(){Hclear(),drawJoystick(),drawDAR()}let lastT=performance.now()/1e3;function tick(){const e=performance.now()/1e3,t=Math.min(.033,Math.max(.001,e-lastT));lastT=e,orbitOn&&(orbitPhase+=t,orbitStep(orbitPhase)),updateGamepadInput(),integrate(t),renderer.setScissorTest(!1),renderer.setViewport(0,0,innerWidth,innerHeight),renderer.render(scene,camera),car&&(gizmoTarget.quaternion.copy(car.quaternion),gizmoAxes.quaternion.copy(gizmoTarget.quaternion));const a=document.getElementById("gizmoFrame").getBoundingClientRect(),n=Math.floor(a.left),r=Math.floor(innerHeight-a.bottom),i=Math.floor(a.width),s=Math.floor(a.height);renderer.setScissorTest(!0),renderer.setScissor(n,r,i,s),renderer.setViewport(n,r,i,s),renderer.render(gizmoScene,gizmoCam),renderer.setScissorTest(!1),renderHUD(),requestAnimationFrame(tick)}function resize(){renderer.setSize(innerWidth,innerHeight),camera.aspect=innerWidth/innerHeight,camera.updateProjectionMatrix(),sizeHud(),clampJoyCenter(),clampDARCenter(),positionHints(),applyZoom()}addEventListener("resize",resize);const gltfLoader=new GLTFLoader;function clearCarMeshesKeepGadgets(){if(!car)return;const e=new Set([faceArrow,faceTip]),t=[];car.children.forEach(a=>{e.has(a)||t.push(a)}),t.forEach(e=>{car.remove(e),e.traverse?.(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose?.()})})}function swapInGLB(){gltfLoader.load("./models/octane.glb",e=>{const t=e.scene||e.scenes?.[0];if(!t){console.warn("[GLB] No scene in file");return}const a=new THREE.Box3().setFromObject(t),n=a.getSize(new THREE.Vector3),r=a.getCenter(new THREE.Vector3);t.position.sub(r),n.x>1.2*n.z&&(t.rotation.y=-Math.PI/2);const i=BOX?Math.max(2*BOX.hx,2*BOX.hy,2*BOX.hz):240,s=Math.max(n.x,n.y,n.z)||1,l=i/s;t.scale.setScalar(l),clearCarMeshesKeepGadgets(),car.add(t);const d=new THREE.Box3().setFromObject(t),c=d.getSize(new THREE.Vector3);BOX={hx:c.x/2,hy:c.y/2,hz:c.z/2},faceArrow&&faceTip&&(()=>{const x=BOX.hz+FACE_OFFSET,g=faceArrow.geometry.attributes.position.array;g[0]=0,g[1]=0,g[2]=x+FACE_EPS,g[3]=0,g[4]=0,g[5]=x+FACE_EPS,faceArrow.geometry.attributes.position.needsUpdate=!0,faceTip.position.set(0,0,x+FACE_EPS)})(),applySpawnOrientation()},void 0,e=>{console.error("[GLB] load failed:",e)})}buildCar(presets.octane,"octane"),applySpawnOrientation(),setRoll(-1),positionHints(),applyZoom(),swapInGLB(),requestAnimationFrame(tick);</script></body></html>
